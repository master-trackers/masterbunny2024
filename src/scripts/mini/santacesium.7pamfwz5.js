var url=new URL(window.location.href);let placedBaskets=[],startallowed=!1,alreadyremovediss=!1,alreadyinsertediss=!1,trackeneityenabled=!0,debounce13479812734=!1,activelyturning=!1,lastcitywikipageurl=null,nextcitywikipageurl=null,allowedtotweenheight=!0,ended2=!1,actualtime,allowedtoheightincrease2=!0,allowedtofrontoscilate=!0,allowedtocameraeffect=!1,isheadingrn=!1,allowedtotrackedentity=!1;var alreadyrolled=!1,prog1=0;let height2=0,height3=15300,iscurrentlydelivering=!0,allowedtohead=!1,imageData,isrollingrandomly=!1,basketsfoundyet=!0,isheadingchanging=!1,prog1set=!1,randomstrings68characters=Math.random().toString(36).substring(2,70),timetoview=3.3;function deleteEntityById(e,t){t=e.entities.getById(t);t&&e.entities.remove(t)}function updateRoll(e){roll=e,console.log("Roll:",roll)}function findPercentage(e,t,i){return(t-e)/(i-e)*100}TweenLite.ticker.useRAF(!1),TweenLite.lagSmoothing(0),(async()=>{try{var e=await fetch("https://temp.master-trackers.xyz/images");if(!e.ok)throw new Error("Network response was not ok: "+e.statusText);imageData=await e.json()}catch(e){console.error("Error fetching the JSON:",e),warnuserError("Error","There was an error getting the route images.")}})();var timeLeftValue=0;let presentsdeliverednumber;function rollabit(e,t){TweenLite.to({progress:0},t,{progress:e,ease:Linear.easeInOut,onUpdate:function(){updateRoll(this.target.progress)},onComplete:function(){console.log("Roll reset completed")}})}function openLastSeen(){var e=window.open("","_blank","width=600,height=400,top=100,left=100");e.document.title="Last Seen City Wikipedia Page",e.location.href=lastcitywikipageurl}function openNextCity(){var e=window.open("","_blank","width=600,height=400,top=100,left=100");e.document.title="Next City Wikipedia Page",e.location.href=nextcitywikipageurl}async function getLatLongFromIPAddress(){var e,t;if(localStorage.getItem("storedIP"))return e=localStorage.getItem("latitude"),t=localStorage.getItem("longitude"),{latitude:parseFloat(e),longitude:parseFloat(t)};try{var i=await(await fetch("/ipinfo?request.preventcache="+randomstrings68characters)).json();return localStorage.setItem("storedIP",!0),localStorage.setItem("latitude",i.latitude),localStorage.setItem("longitude",i.longitude),{latitude:i.latitude,longitude:i.longitude}}catch(e){return console.error("Error getting latitude and longitude:",e),warnuserError("Error","There was an error getting data for the arrival time."),null}}function handleInternetLoss(){warnuserWarning("Connection Warning","You have lost internet connection, according to our site. Please check your connection, this tracker will continue to run temporarily, but without a connection, it may stop.")}function handleCesiumIonError(e){console.error("Cesium Ion Error:",e),viewer&&location.reload()}function toggleSettings(){var e=document.getElementById("settingsPopup");"block"===e.style.display?e.style.display="none":e.style.display="block"}function getFlagImageUrl(e){return e.includes("http://")||e.startsWith("https://")?e:`https://flagcdn.com/w320/${e.toLowerCase()}.png`}window.addEventListener("offline",handleInternetLoss),window.addEventListener("online",()=>{console.log("Internet connection restored.")});let basketUpdateInterval,basketElement=document.getElementById("basketsInfo"),currentCountry,currentCount=0;function startBasketCounter(e,t,i){e=Number(e),t=Number(t),i=Number(i);let a={count:t};TweenLite.to(a,e,{count:i,ease:Linear.easeIn,onUpdate:function(){basketElement.textContent=Math.round(a.count).toLocaleString(),!0===ended2&&setTimeout(()=>{basketElement.textContent=Math.round(a.count).toLocaleString()+", one for Santa ðŸ˜Š."},2e3)},onComplete:function(){console.log("Basket counter complete")}})}function yourFunctionToRunWhenTrackerEnds(){source.close(),window.location.href="/"}Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyM2Q1MWUyYS1kMDcxLTRmNmEtOWEwNC0wZTE4MjgzNmIyYWMiLCJpZCI6MTk2NTMyLCJpYXQiOjE3MDgzNzQ0NzJ9.GEf0dmAehNxx5LwDn4vzMd-XuwXVgAFXxvHB6IwUKNc";var viewer=new Cesium.Viewer("cesiumContainer",{terrain:Cesium.Terrain.fromWorldTerrain({requestWaterMask:!0}),skyAtmosphere:!1,shouldAnimate:!0});viewer.camera.frustum.fov=Cesium.Math.toRadians(120);let googleMapsLayer=new Cesium.UrlTemplateImageryProvider({url:"https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}"}),skyBox=(viewer.imageryLayers.addImageryProvider(googleMapsLayer),new Cesium.SkyBox({sources:{positiveX:"/assets/black.png",negativeX:"/assets/black.png",positiveY:"/assets/black.png",negativeY:"/assets/black.png",positiveZ:"/assets/black.png",negativeZ:"/assets/black.png"}}));var currentLatitude=83.6;let citylocation213;var currentLongitude=168,targetLatitude=0,targetLongitude=0;function getRandomCoordinates(){return{lat:180*Math.random()-90,lon:360*Math.random()-180}}function beginRollRequest(e,t,i,a,n){var r=parseInt(n)/3,n=heading,e=Cesium.Cartographic.fromDegrees(e,t,4e4),t=Cesium.Cartographic.fromDegrees(i,a,4e4),i=Cesium.Math.toRadians(30),a=new Cesium.EllipsoidGeodesic(e,t);Math.abs(n);e=(a.startHeading+180)%360-180;console.log("Timeout delay:",2*r);let o=n<e?i:-i;setTimeout(()=>{console.log("Starting TweenLite animation after timeout..."),TweenLite.to({progress:roll},r,{progress:o,ease:Power1.easeIn,onUpdate:function(){roll=this.target.progress},onComplete:function(){console.log("TweenLite animation complete."),alreadyrolled=!1}})},2*r)}var santa2=viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(currentLongitude,currentLatitude,4e4),id:"santa2",model:{uri:"/assets/bunny2.gltf",scale:100.1},orientation:Cesium.Transforms.headingPitchRollQuaternion(Cesium.Cartesian3.fromDegrees(currentLongitude,currentLatitude,4e4),new Cesium.HeadingPitchRoll(0,0,0))});let startTime=Cesium.JulianDate.fromDate(new Date(currenttimeunixsec));viewer.clock.startTime=startTime.clone(),viewer.clock.currentTime=startTime.clone(),viewer.clock.stopTime=Cesium.JulianDate.addSeconds(startTime,3600,new Cesium.JulianDate),viewer.clock.clockRange=Cesium.ClockRange.LOOP_STOP,viewer.clock.multiplier=1,viewer.clock.shouldAnimate=!0;var santa=viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(currentLongitude,currentLatitude,4e4),id:"santa",model:{uri:"/assets/invisible.glb",scale:50.1},orientation:Cesium.Transforms.headingPitchRollQuaternion(Cesium.Cartesian3.fromDegrees(currentLongitude,currentLatitude,4e4),new Cesium.HeadingPitchRoll(0,0,0))}),northpole=viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(0,90,200),id:"northpole",model:{uri:"/assets/npisland.gltf",scale:90.1}});santa.allowPicking=!1,santa2.allowPicking=!1;let pitch=0,roll=0,debounceTimeout,scene=(viewer.clock.clockRange=Cesium.ClockRange.LOOP_STOP,viewer.clock.multiplier=1,viewer.clock.shouldAnimate=!0,viewer.scene),frequency=5,amplitude=.08;function updategraphics(e,t,i,a,n,r){console.log("Graphics updated:"),console.log("Front Oscillation:",e),e="false",allowedtofrontoscilate=!1,height2=31e3,console.log("Height Oscillation:",t),allowedtotweenheight=Boolean(t),console.log("Snow:",i),console.log("Water:",a),!1===Boolean(a)?viewer.requestWaterMask=function(){return console.log("requestWaterMask has been disabled."),Promise.resolve(null)}:viewer.requestWaterMask,console.log("Hybrid:",n),!0===Boolean(n)?viewer.imageryLayers.addImageryProvider(googleMapsLayer):viewer.imageryLayers.remove(googleMapsLayer),console.log("Camera Effects:",r),!0===Boolean(r)?(allowedtocameraeffect=!0,setTimeout(()=>{Down3()},1e3)):allowedtocameraeffect=!1}function applyGraphicsSettings(e){updategraphics(e["Santa Sleigh Front End Oscillation"],e["Santa Sleigh Height Oscillation"],e["Screen Snow"],e["Animated Water"],e["Google Hybrid"],e["Camera Raises and Lowers with Sleigh"])}document.addEventListener("DOMContentLoaded",()=>{var e=JSON.parse(localStorage.getItem("laginducedsettings"));e&&applyGraphicsSettings(e)}),window.addEventListener("storage",function(e){"laginducedsettings"===e.key&&(e=JSON.parse(e.newValue),console.log("UPDATING KEYS"),applyGraphicsSettings(e))});let lastFrameTime=performance.now(),frameCount=0;function checkFrameRate(){var e=performance.now(),t=e-lastFrameTime;lastFrameTime=e,16.67<t&&handleLowFramerate(20),requestAnimationFrame(checkFrameRate)}function handleLowFramerate(e){console.warn("Framerate dropped below 20 FPS! Current FPS: "+e),viewer.requestWaterMask=function(){return console.log("requestWaterMask has been disabled."),Promise.resolve(null)},allowedtotweenheight=!1,warnuserWarning("Low Framerate Detected","The tracker may be running slowly on your device. We automatically reverted to lower graphical settings for you.")}function Up(){!0===allowedtofrontoscilate&&!0===allowedtoheightincrease2&&TweenLite.to({progress:-1*amplitude/2},5,{progress:2*amplitude,ease:Power1.easeInOut,onUpdate:function(){pitch=this.target.progress},onComplete:Down})}function Down(){!0===allowedtofrontoscilate&&!0===allowedtoheightincrease2&&TweenLite.to({progress:2*amplitude},5,{progress:-1*amplitude/2,ease:Power1.easeInOut,onUpdate:function(){pitch=this.target.progress},onComplete:Up})}function Up2(){!0===allowedtotweenheight&&!0===allowedtoheightincrease2?TweenLite.to({progress:13100},5,{progress:15100,ease:Power1.easeInOut,onUpdate:function(){height2=this.target.progress},onComplete:Down2}):height2=15100}function Down2(){!0===allowedtotweenheight&&!0===allowedtoheightincrease2?TweenLite.to({progress:15100},5,{progress:13100,ease:Power1.easeInOut,onUpdate:function(){height2=this.target.progress},onComplete:Up2}):height2=15100}function Up3(){!0===allowedtocameraeffect&&TweenLite.to({progress:13100},5,{progress:15100,ease:Power1.easeInOut,onUpdate:function(){height3=this.target.progress},onComplete:Down3})}function Down3(){!0===allowedtocameraeffect&&TweenLite.to({progress:15100},5,{progress:13100,ease:Power1.easeInOut,onUpdate:function(){height3=this.target.progress},onComplete:Up3})}Up(),setTimeout(()=>{Up2()},2200);let currentPos,heading,hasRun1234124514=!1;!0===allowedtotrackedentity&&!0===trackeneityenabled&&(viewer.trackedEntity=santa);var validStepSize,allowedtofly2=!0,time12983748923714=0;function startValidStepSize(){}function calculateCoordsAheadCesium(e,t,i){e=Cesium.Math.toRadians(e),i=Cesium.Cartographic.fromDegrees(i,t),t=Cesium.Ellipsoid.WGS84,i=t.cartographicToCartesian(i),e=new Cesium.Cartesian3(Math.cos(e),Math.sin(e),0),e=Cesium.Cartesian3.multiplyByScalar(e,100,new Cesium.Cartesian3),i=Cesium.Cartesian3.add(i,e,new Cesium.Cartesian3),e=t.cartesianToCartographic(i);return{lat:Cesium.Math.toDegrees(e.latitude),lon:Cesium.Math.toDegrees(e.longitude)}}let result=calculateCoordsAheadCesium(90,40.748817,-73.985428),isTweening=(console.log(`New coordinates: Latitude ${result.lat}, Longitude `+result.lon),!1),allowedtoroll=!0,hasrotatedyet=!1,hasRun1515=!1;function flyToSanta(e,t,i,c,a,n,r,o,s,l){var u,d,m,g,p;hasrotatedyet=!1,"number"!=typeof i||i<=0?console.error("Invalid time value"):(d=Cesium.JulianDate.fromDate(new Date(currenttimeunixsec)),Cesium.JulianDate.addSeconds(d,i,new Cesium.JulianDate),u=60*i,d=Cesium.Cartographic.fromDegrees(a,n,4e4*o),m=Cesium.Cartographic.fromDegrees(t,e,4e4*r),g=new Cesium.EllipsoidGeodesic(d,m),hasRun1515||(a=findPercentage(s,Math.floor(currenttimeunixsec/1e3),l),prog1=0+a/100*1,prog1set=!1,heading=g.startHeading,hasRun1515=!0),p=setInterval(function(){if(u<0)clearInterval(p);else if(c===citylocation213){isTweening||((isTweening=!0)===prog1set&&(prog1=0),!1===activelyturning&&(allowedtoroll=!1,TweenLite.to({progress:prog1},actualtime,{progress:1,ease:Linear.easeInOut,onUpdate:function(){var e,t,i;!1===isheadingrn&&(e=santa.position.getValue(Cesium.JulianDate.fromDate(new Date(currenttimeunixsec))),e=Cesium.Ellipsoid.WGS84.cartesianToCartographic(e),i=Cesium.Math.toDegrees(e.longitude),t=Cesium.Math.toDegrees(e.latitude),e=e.height,i=Cesium.Cartographic.fromDegrees(i,t,e),t=new Cesium.EllipsoidGeodesic(i,m),heading=t.startHeading),e=this.target.progress,(i=g.interpolateUsingFraction(e))?(t=Cesium.Cartesian3.fromRadians(i.longitude,i.latitude,height3),i=Cesium.Cartesian3.fromRadians(i.longitude,i.latitude,height2),santa.position=t,santa2.position=i,santaOverlay.position=t):console.error("currentPos is undefined at progress:",e)},onComplete:function(){isTweening=!1,allowedtohead=!0,allowedtoroll=!0}})));var e=heading,t=g.startHeading-e,i=(Cesium.Math.toRadians(.864699),Cesium.Math.toRadians(.0015),Cesium.Math.toRadians(3)),a=Cesium.Math.toRadians(30);if(Math.abs(t)>i&&!0===allowedtohead&&!isheadingchanging&&!hasrotatedyet){isheadingrn=!0,hasrotatedyet=!0;t=Math.abs(e),i=g.startHeading;function n(e){return(e+Math.PI)%(2*Math.PI)-Math.PI}var e=n(e),r=n(i),o=n(r),s=(l=o,s=n(s=e),l=n(l),s=0<=(l=n(l-s))?l:2*Math.PI+l,l=l<=0?-l:2*Math.PI-l,s<=l?s:-l),l=e+s,r=(console.log("Normalized Current Heading:",e),console.log("Normalized Target Heading:",r),console.log("Normalized Adjusted Heading:",o),console.log("Shortest Angle Difference (clockwise prioritized):",s),console.log("Updated Heading (radians):",l),e<l?a:-a);isheadingchanging=!0;TweenLite.to({progress:roll},1,{progress:-r,ease:Power1.easeInOut,onUpdate:function(){updateRoll(this.target.progress)}}),console.log("Current Heading (radians):",t),console.log("Target Heading (radians):",i),TweenLite.to({progress:e},4,{progress:l,ease:Linear.easeInOut,onUpdate:function(){var e=this.target.progress;heading=e,console.log("Updated Heading (radians):",e)},onComplete:function(){console.log("Heading adjustment completed"),TweenLite.to({progress:roll},1,{progress:0,ease:Power1.easeInOut,onUpdate:function(){updateRoll(this.target.progress)},onComplete:function(){isheadingrn=!1,console.log("Roll reset completed")}}),isheadingchanging=!1}})}}var s,l},1e3*i/u),!0===allowedtotrackedentity&&!0===trackeneityenabled&&(viewer.trackedEntity=santa))}function myFunctio2(){var e=Cesium.JulianDate.fromDate(new Date(currenttimeunixsec));santa2.orientation=Cesium.Transforms.headingPitchRollQuaternion(santa2.position.getValue(e),new Cesium.HeadingPitchRoll(heading,roll,pitch)),santa.orientation=Cesium.Transforms.headingPitchRollQuaternion(santa.position.getValue(e),new Cesium.HeadingPitchRoll(heading,roll,pitch)),santaOverlay.orientation=Cesium.Transforms.headingPitchRollQuaternion(santa.position.getValue(e),new Cesium.HeadingPitchRoll(heading,roll,pitch))}viewer.scene.preRender.addEventListener(myFunctio2);var ISS,nobaskets=url.searchParams.get("nobaskets");async function fetchBaskets(){try{var e=await(await fetch("/getbaskets")).json();0===e.length?basketsfoundyet=!1:e.forEach(e=>{addBasket(e)})}catch(e){console.error("Error fetching baskets:",e),warnuserError("Error","There was an error getting old gifts delivered.")}}function celsiusToFahrenheit(e){return 9*e/5+32}function truncateText(e,t){return e.length>t?e.substring(0,t)+"...":e}function roundToThreeDecimalPlaces(e){return parseFloat(e).toFixed(1)}"1"!==nobaskets&&fetchBaskets(),viewer.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);let billboardCollection=new Cesium.BillboardCollection({scene:viewer.scene});function addBasket(t){if("pt"!==t.country){var i=placedBaskets.some(e=>e[0]===t.latitude&&e[1]===t.longitude);if(!i){let e=15190;"International Space Station"===t.city&&(e=300100),placedBaskets.push([t.latitude,t.longitude]);i=(t.Wikipedia_attr||"").includes("youtube.com")?"/assets/camera.png":"/assets/basket.png";300100===e&&(i="/assets/isspresent.png"),billboardCollection.add({position:Cesium.Cartesian3.fromDegrees(t.longitude,t.latitude,e),image:i,scale:.1}).cityInfo=t}}}function addBasketInactive(t){if("pt"!==t.country&&t["Unix Arrival Arrival"]){var i=placedBaskets.some(e=>e[0]===t.Latitude&&e[1]===t.Longitude);if(!i){let e=15190;"International Space Station"===t.city&&(e=300100),placedBaskets.push([t.Latitude,t.Longitude]);i=(t["Wikipedia attr"]||"").includes("youtube.com")?"/assets/camera.png":"/assets/basket.png";300100===e&&(i="/assets/isspresent.png"),billboardCollection.add({position:Cesium.Cartesian3.fromDegrees(t.Longitude,t.Latitude,e),image:i,scale:.1}).cityInfo=t}}}function showPopup(e){let t=document.getElementById("popup-container");document.getElementById("popup-content").innerHTML=e,t.style.display="block",t.style.zIndex="999999",t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",document.getElementById("close-btn").onclick=()=>{t.style.display="none"}}viewer.scene.primitives.add(billboardCollection),TweenLite.ticker.autoSleep=!1;let handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);handler.setInputAction(function(e){var e=viewer.scene.pick(e.position);Cesium.defined(e)&&e.primitive instanceof Cesium.Billboard&&showPopup(`
      <div style="font-family: Arial, sans-serif; color: #fff; background: #333; padding: 10px; border-radius: 8px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <img src="${getFlagImageUrl((e=e.primitive.cityInfo).cc)}" width="20px" style="margin-right: 10px;">
          <b>${e.city}, ${e.country}</b>
        </div>
        <div><strong>Arrival Time:</strong> ${new Date(1e3*e.unixdeparture).toLocaleString()}</div>
        <div>
          <a href="${e.Wikipedia_attr}" target="_blank" style="color: #007BFF; text-decoration: none;">
            More Info
          </a>
        </div>
      </div>`)},Cesium.ScreenSpaceEventType.LEFT_CLICK);let lastcitystopped;async function getTimeUntilArrival(e,t){try{return await(await fetch(`/gettimeofarrival?lat=${e}&long=`+t)).json()}catch(e){return console.error("Error getting time until arrival:",e),warnuserError("Error","There was an error fetching the time until arrival."),null}}function formatArrivalTime(t){t=(t-currenttimeunixsec/1e3)/3600;if(t<1)return(i=Math.round(60*t))<15?"Less than 15 minutes!":i%15==0?i/60+" hours":1===(i=Math.round(i/15))?"Â¼ hours":2===i?"Â½ hours":3===i?"Â¾ hours":i+"/4 hours";if(1==t)return"1 hour";{var i=Math.floor(t),t=Math.round(60*(t-i));let e="";return e=0===t?i+" "+(1===i?"hour":"hours"):15===t?i+" Â¼ hours":30===t?i+" Â½ hours":45===t?i+" Â¾ hours":1===(t=Math.round(t/15))?i+" Â¼ hours":2===t?i+" Â½ hours":3===t?i+" Â¾ hours":i+" hours"}}async function main(){updateweatherinfo();try{var e,t,i,{latitude:o,longitude:s}=await getLatLongFromIPAddress();if(o&&s){let{nearestCity:a,timeUntilArrival:n}=await getTimeUntilArrival(o,s),r=(localStorage.setItem("nearestcity",a),document.getElementById("arrivalTime"));n>=currenttimeunixsec/1e3?r.innerText="The Easter Bunny will arrive in: "+formatArrivalTime(n):(t=(e=new Date(1e3*n)).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0}),i=e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),document.getElementById("arrivalTime2").innerText=t+" in "+a,r.innerText="The Easter Bunny arrived at: "+i),setInterval(()=>{var e,t,i;n>=currenttimeunixsec/1e3?r.innerText="The Easter Bunny will arrive in: "+formatArrivalTime(n):(t=(e=new Date(1e3*n)).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0}),i=e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),rmattedArrivalTime=e.toLocaleString(),document.getElementById("arrivalTime2").innerText=t+" in "+a,r.innerText="The Easter Bunny arrived at: "+i)},6e4)}else console.error("Latitude and longitude not available.")}catch(e){console.error("An error occurred:",e),warnuserError("Error","There was an error getting data for arrival time.")}}async function fetchRouteData(){try{(await(await fetch("/getbaskets")).json()).length<2&&(basketsfoundyet=!1)}catch(e){console.error("Error fetching baskets:",e)}try{var t=await fetch("/route");if(!t.ok)throw new Error("Network response was not ok: "+t.statusText);let e=await t.text();setInterval(()=>{handleSSE(processRouteData(parseRouteData(e)))},1e3)}catch(e){console.error("Error fetching route data:",e),warnuserError("Error","There was an error getting the route data.")}}function runFetchAtNextSecond(){fetchRouteData()}main(),runFetchAtNextSecond();let hasHandledNoNextCity=!1;function parseRouteData(e){try{return JSON.parse(e)}catch(e){return console.error("Error parsing route data:",e),warnuserError("Error","There was an error parsing the route data."),[]}}let hasStarted=!1;function processRouteData(t){var i=Math.floor(currenttimeunixsec/1e3);let a=null,n=null,r=null,o=null;for(let e=0;e<t.length;e++){var s=t[e],l=s["Unix Arrival Arrival"];if(l&&!isNaN(l)){if(n&&(r=n),i<l){a=s,n=n||s,e+1<t.length&&(l=t[e+1],o=l);break}!1===basketsfoundyet&&addBasketInactive(s),n=s}}return!a&&n&&(r=n),a&&!hasStarted&&(startallowed=!0,startview(),hasStarted=!0),n=n||{},a||(ended2=!0,document.getElementById("endingtext").style.visibility="visible",document.getElementById("hideavailable").style.visibility="hidden",document.getElementById("lastseeninfobox").style.visibility="hidden",document.getElementById("lastseeninfobox3").style.visibility="hidden",deleteEntityById(viewer,"santa"),deleteEntityById(viewer,"santa2"),hasHandledNoNextCity||(hasHandledNoNextCity=!0,startallowed=!1,handleNoNextCity()),setInterval(()=>{deleteEntityById(viewer,"santa"),deleteEntityById(viewer,"santa2"),deleteEntityById(viewer,"santaoverlaythingy")},1e3)),convertData({currentCity:extractCityData(n),timeLeft:calculateTimeLeft(a),nextCity:extractCityData(a||n),nextNextCity:extractCityData(o||n),lastCity:extractCityData(r),newBasket:extractCityData(n)})}function updateweatherinfo(){document.getElementById("weatheronarrival").innerText="We're working on getting this information, please bear with us.",setTimeout(()=>{document.getElementById("weatheronarrival").innerText="This will only take a few moments.";var e=localStorage.getItem("nearestcity");e?fetch("/getweatherfromcity?city="+e).then(e=>e.json()).then(e=>{var{city:e,country:t,weather:i}=e,a=i.temperature,i=i.description,a=(9*a/5+32).toFixed(2)+"Â°F";document.getElementById("weatheronarrival").innerText=`In ${e}, ${t}, it was ${a} with ${i}.`}).catch(e=>{console.error("Error fetching weather data:",e),document.getElementById("weatheronarrival").innerText="Sorry, we couldn't retrieve the weather data at this time."}):document.getElementById("weatheronarrival").innerText="City not found in localStorage."},100)}let latatat=0,longonon=0,height666666=5e6;function handleNoNextCity(){allowedtotrackedentity=!1,updateweatherinfo(),document.getElementById("followbutton").hidden=!0;var e=localStorage.getItem("locationHid"),t=localStorage.getItem("longitude"),i=localStorage.getItem("latitude");("false"===e||!e&&t&&i)&&(latatat=i,longonon=t,height666666=25e4),trackeneityenabled=!1,viewer.trackedEntity=void 0,setTimeout(()=>{viewer.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(longonon,latatat,height666666),duration:3})},1e3),setTimeout(()=>{deleteEntityById(viewer,"santaOverlay")},1e4)}let obj={trackeneityenabled:!1},handler2={set(e,t,i){return"trackeneityenabled"===t&&(console.log("trackeneityenabled changed to "+i),i?console.log("track enabled"):disableTracking()),e[t]=i,!0}};function updatelocationsettings(){var e=localStorage.getItem("locationHid");"true"===e?(document.getElementById("hidelocation").hidden=!0,document.getElementById("hidelocation2").hidden=!0):"false"===e&&(document.getElementById("hidelocation").hidden=!1,document.getElementById("hidelocation2").hidden=!1)}let proxy=new Proxy(obj,handler2);function disableTracking(){viewer.trackedEntity=void 0,setTimeout(()=>{viewer.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(0,0,15e5),duration:3})},1e3)}function triggerFunctions(){!0===trackeneityenabled?(trackeneityenabled=!1,document.getElementById("FollowButtonImage").src="/assets/followcam.png",disableTracking()):(document.getElementById("FollowButtonImage").src="/assets/unfollowicon.png",trackeneityenabled=!0,viewer.trackedEntity=santa)}function extractCityData(e){return{unixArrivalArrival:e["Unix Arrival Arrival"]||0,unixArrival:e["Unix Arrival"]||0,unixDeparture:e["Unix Departure"]||0,city:e.City||"Unknown",country:e.Region||"Unknown",cc:e.CC||"None",timezone:e.Timezone||"Unknown",basketsdelivered:e["Eggs Delivered"]||0,carrotsEaten:e["Carrots eaten"]||0,latitude:e.Latitude||"0",longitude:e.Longitude||"0",popNum:e["Population Num"]||0,popYear:e["Population Year"]||"Unknown",elevationMeter:e["Elevation Meter"]||0,arrivalStoppageTime:e["Arrival Stoppage Time"]||0,wikipediaAttr:e["Wikipedia attr"]||"None",wikipediaLink:e["Wikipedia Link"]||"None"}}function calculateTimeLeft(e){return(e?e["Unix Arrival Arrival"]:0)-Math.floor(currenttimeunixsec/1e3)}function convertData(e){return{currentCity:{unixarrivalarrival:e.currentCity.unixArrivalArrival,unixarrival:e.currentCity.unixArrival,unixdeparture:e.currentCity.unixDeparture,city:e.currentCity.city,country:e.currentCity.country,cc:e.currentCity.cc,timezone1:e.currentCity.timezone,basketsdelivered:e.currentCity.basketsdelivered,carrots_eaten:e.currentCity.carrotsEaten,latitude:e.currentCity.latitude,longitude:e.currentCity.longitude,pop_num:e.currentCity.popNum,pop_year:e.currentCity.popYear,Elevation_Meter:e.currentCity.elevationMeter,Arrival_Stoppage_Time:e.currentCity.arrivalStoppageTime,timezone:e.currentCity.timezone,Wikipedia_attr:e.currentCity.wikipediaAttr,wikipedia_link:e.currentCity.wikipediaLink},timeLeft:e.timeLeft,nextCity:{unixarrivalarrival:e.nextCity.unixArrivalArrival,unixarrival:e.nextCity.unixArrival,unixdeparture:e.nextCity.unixDeparture,city:e.nextCity.city,country:e.nextCity.country,cc:e.nextCity.cc,timezone1:e.nextCity.timezone,basketsdelivered:e.nextCity.basketsdelivered,carrots_eaten:e.nextCity.carrotsEaten,latitude:e.nextCity.latitude,longitude:e.nextCity.longitude,pop_num:e.nextCity.popNum,pop_year:e.nextCity.popYear,Elevation_Meter:e.nextCity.elevationMeter,Arrival_Stoppage_Time:e.nextCity.arrivalStoppageTime,timezone:e.nextCity.timezone,Wikipedia_attr:e.nextCity.wikipediaAttr,wikipedia_link:e.nextCity.wikipediaLink},nextNextCity:{unixarrivalarrival:e.nextNextCity.unixArrivalArrival,unixarrival:e.nextNextCity.unixArrival,unixdeparture:e.nextNextCity.unixDeparture,city:e.nextNextCity.city,country:e.nextNextCity.country,cc:e.nextNextCity.cc,timezone1:e.nextNextCity.timezone,basketsdelivered:e.nextNextCity.basketsdelivered,carrots_eaten:e.nextNextCity.carrotsEaten,latitude:e.nextNextCity.latitude,longitude:e.nextNextCity.longitude,pop_num:e.nextNextCity.popNum,pop_year:e.nextNextCity.popYear,Elevation_Meter:e.nextNextCity.elevationMeter,Arrival_Stoppage_Time:e.nextNextCity.arrivalStoppageTime,timezone:e.nextNextCity.timezone,Wikipedia_attr:e.nextNextCity.wikipediaAttr,wikipedia_link:e.nextNextCity.wikipediaLink},lastCity:{unixarrivalarrival:e.lastCity.unixArrivalArrival,unixarrival:e.lastCity.unixArrival,unixdeparture:e.lastCity.unixDeparture,city:e.lastCity.city,country:e.lastCity.country,cc:e.lastCity.cc,timezone1:e.lastCity.timezone,basketsdelivered:e.lastCity.basketsdelivered,carrots_eaten:e.lastCity.carrotsEaten,latitude:e.lastCity.latitude,longitude:e.lastCity.longitude,pop_num:e.lastCity.popNum,pop_year:e.lastCity.popYear,Elevation_Meter:e.lastCity.elevationMeter,Arrival_Stoppage_Time:e.lastCity.arrivalStoppageTime,timezone:e.lastCity.timezone,Wikipedia_attr:e.lastCity.wikipediaAttr,wikipedia_link:e.lastCity.wikipediaLink},newBasket:{unixarrivalarrival:e.newBasket.unixArrivalArrival,unixarrival:e.newBasket.unixArrival,unixdeparture:e.newBasket.unixDeparture,city:e.newBasket.city,country:e.newBasket.country,cc:e.newBasket.cc,timezone1:e.newBasket.timezone,basketsdelivered:e.newBasket.basketsdelivered,carrots_eaten:e.newBasket.carrotsEaten,latitude:e.newBasket.latitude,longitude:e.newBasket.longitude,pop_num:e.newBasket.popNum,pop_year:e.newBasket.popYear,Elevation_Meter:e.newBasket.elevationMeter,Arrival_Stoppage_Time:e.newBasket.arrivalStoppageTime,timezone:e.newBasket.timezone,Wikipedia_attr:e.newBasket.wikipediaAttr,wikipedia_link:e.newBasket.wikipediaLink}}}window.addEventListener("storage",function(e){"longitude"!==e.key&&"latitude"!==e.key&&"nearestcity"!==e.key||main(),"locationHid"===e.key&&updatelocationsettings()}),updatelocationsettings();let debounceTimeout2=!1,presetCityUrl="https://theelevatedmoments.com/wp-content/uploads/2023/12/A63I8240.jpg",lastCity44444=null;function setCityImage(e){var t,i,a;!0!==debounceTimeout2&&(debounceTimeout2=!0,t=document.getElementById("flag3"),imageData[e]&&0<imageData[e].length?(i=(i=imageData[e])[Math.floor(Math.random()*i.length)],t.src=i.url,t.setAttribute("alt","Image for "+e),a=e.split(",").slice(0,2).join(", "),document.getElementById("flag3title").innerText=a,document.getElementById("lastCityInfo3").innerHTML=`Â© <a target="_blank" href="${i.attribution}">Attribution</a>`):(t.src=presetCityUrl,t.setAttribute("alt","Default city image"),document.getElementById("flag3title").innerText="",document.getElementById("lastCityInfo3").innerHTML="No image available."),lastCity44444=e)}setInterval(()=>{debounceTimeout2=!1},2e4);var allowrollrequest=!1;async function activateWakeLock(){if("wakeLock"in navigator&&window.isSecureContext)try{await navigator.wakeLock.request("display"),console.log("Display wake lock is active.")}catch(e){console.error("Failed to acquire wake lock: "+e)}else console.log("Wake Lock API is not supported or not available in this context.")}function handleSSE(e){let t;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){return console.error("Error parsing event data:",e),void warnuserError("Error","An unknown error occured.")}else{if("object"!=typeof e)return console.error("Unexpected event format:",e),void warnuserError("Error","An unknown error occured.");t=e}function i(e){var t=Math.floor(e/31536e3),i=(e-=3600*t*24*365,Math.floor(e/86400)),a=(e-=3600*i*24,Math.floor(e/3600)),n=(e-=3600*a,Math.floor(e/60));e-=60*n;let r="";return 0<t&&(r+=t+` year${1<t?"s":""} `),0<i&&(r+=i+` day${1<i?"s":""} `),0<a&&(r+=a+` hour${1<a?"s":""} `),0<n&&(r+=n+` minute${1<n?"s":""} `),0<e&&(r+=e+" second"+(1<e?"s":"")),r.trim()}!0===startallowed&&(parseInt(t.timeLeft,10)<=parseInt(t.currentCity.Arrival_Stoppage_Time,10)?(isrollingrandomly=!0,t.nextNextCity.latitude,t.nextNextCity.longitude):isrollingrandomly=!1,!0===t.trackerended&&window.open("/"),citylocation213=t.nextCity.city,timeLeftValue=t.timeLeft,t.trackerEnded,t.nextCity)&&(actualtime=t.nextCity.unixarrivalarrival-currenttimeunixsec/1e3,console.log(t.nextCity.unixarrivalarrival-currenttimeunixsec/1e3),lastcitywikipageurl=t.lastCity.Wikipedia_attr,nextcitywikipageurl=t.nextCity.Wikipedia_attr,nobaskets||t.lastCity&&addBasket(t.lastCity),"pt"===t.lastCity.country?(setInterval(()=>{var e,t=new Date(currenttimeunixsec),i=new Date(t),i=(i.setUTCHours(9,0,0,0),9<=t.getUTCHours()&&i.setUTCDate(t.getUTCDate()+1),i-t);i<0||(t=Math.floor(i%864e5/36e5),e=Math.floor(i%36e5/6e4),i=Math.floor(i%6e4/1e3),document.getElementById("launchTimer").textContent=t.toString().padStart(2,"0")+":"+e.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0"))},1e3),document.getElementById("hideavailable").hidden=!0,document.getElementById("launchID").hidden=!1):(document.getElementById("hideavailable").hidden=!1,document.getElementById("launchID").hidden=!0),document.getElementById("nextCityInfo").textContent=t.nextCity?!(t.timeLeft<=parseInt(t.currentCity.Arrival_Stoppage_Time))&&t.nextCity.country.endsWith('"')&&t.nextCity.country.includes("pt")?""+t.nextCity.country.replace(/^"(.*)"$/,"$1"):`${t.nextCity.city.replace(/^"(.*)"$/,"$1")}, ${t.nextCity.country.replace(/^"(.*)"$/,"$1")} in ${i(t.timeLeft)}.`:"",t.timeLeft<=parseInt(t.currentCity.Arrival_Stoppage_Time)?(iscurrentlydelivering=!0,santaOverlay.billboard.image="/assets/bunny.png",moving=!0,stopped=!0):(iscurrentlydelivering=!1,stopped=!0,moving=!0,santaOverlay.billboard.image="/assets/bunny.png"),timeleft2=t.timeLeft,document.getElementById("lastCityInfo").textContent=t.lastCity?`${t.lastCity.city}${e=t.lastCity.country,e.toLowerCase().includes("pt")?"":","} `+((e=t.lastCity.country).endsWith("pt")?e.slice(0,-2):e.replace(/"/g,"")):"",setCityImage(t.nextCity.city+", "+t.nextCity.country),!1===prog1set&&(prog1set=!0),document.getElementById("flag3"),e=getFlagImageUrl(t.nextCity.cc),document.getElementById("flag").src=e,e=getFlagImageUrl(t.lastCity.cc),document.getElementById("flag2").src=e,"pt"!==t.lastCity.country.toLowerCase()==0?document.getElementById("hideavailable").style.display="none":document.getElementById("hideavailable").style.display="block",t.lastCity.city!==lastcitystopped)&&(debounceTimeout2=!1,"International Space Station"===t.nextCity.city?(allowedtoheightincrease2=!1,TweenLite.to({progress:15100},t.timeLeft,{progress:300100,ease:Power1.easeInOut,onUpdate:function(){28e4<=parseInt(this.target.progress)&&!alreadyinsertediss&&(alreadyinsertediss=!0,ISS=viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(t.nextCity.longitude,t.nextCity.latitude,300100),id:"iss",model:{uri:"/assets/ISS.glb",scale:90.1}})),height2=this.target.progress,height3=this.target.progress+200}}),TweenLite.to({progress:pitch},3,{progress:amplitude,ease:Power1.easeInOut,onUpdate:function(){pitch=this.target.progress}})):"International Space Station"===t.lastCity.city?(allowedtoheightincrease2=!1,TweenLite.to({progress:300100},t.timeLeft,{progress:15100,ease:Power1.easeInOut,onUpdate:function(){parseInt(this.target.progress)<=28e4&&!alreadyremovediss&&(alreadyremovediss=!0,viewer.entities.remove(ISS)),height2=this.target.progress,height3=this.target.progress+200}}),TweenLite.to({progress:pitch},3,{progress:-amplitude,ease:Power1.easeInOut,onUpdate:function(){pitch=this.target.progress}})):!1===allowedtoheightincrease2&&(allowedtoheightincrease2=!0,Up(),setTimeout(()=>{Up2()},2200)),startBasketCounter(t.timeLeft,t.lastCity.basketsdelivered,t.nextCity.basketsdelivered),lastcitystopped=t.lastCity.city,setTimeout(()=>{allowrollrequest=!0},parseInt(t.timeLeft)/3*2),flyToSanta(t.nextCity.latitude,t.nextCity.longitude,t.timeLeft,t.nextCity.city,t.lastCity.longitude,t.lastCity.latitude,NaN,NaN,t.lastCity.unixarrivalarrival,t.nextCity.unixarrivalarrival))}activateWakeLock();let cityInfo={longitude:-75.59777,latitude:40.03883},santaOverlay=viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(cityInfo.longitude,cityInfo.latitude),billboard:{image:"/assets/santaoverlay.png",width:50,height:50,show:!1},EyeOffset:new Cesium.Cartesian3(0,0,15e3),id:"santaoverlaythingy"});function startview(){setTimeout(()=>{var e;santa&&santa.position?(e=santa.position.getValue(Cesium.JulianDate.fromDate(new Date(currenttimeunixsec))))?(viewer.camera.flyTo({destination:e,duration:3}),setTimeout(()=>{allowedtotrackedentity=!0,viewer.trackedEntity=santa;e="eyeoffset";var e=new URL(window.location.href).searchParams.get(e),e=e?1e3*parseFloat(e):12e3;viewer.scene.screenSpaceCameraController.minimumZoomDistance=e,setTimeout(()=>{viewer.scene.screenSpaceCameraController.minimumZoomDistance=100},3e3)},3050)):console.error("Santa position is not valid."):console.error("Santa entity or position is not defined.")},2500)}santaOverlay.allowPicking=!1,viewer.camera.changed.addEventListener(()=>{2e5<viewer.camera.getMagnitude()?(santaOverlay.billboard.show=!0,santa2.model.show=!1):(santaOverlay.billboard.show=!1,santa2.model.show=!0)});var bing=new Cesium.BingMapsImageryProvider({url:"https://dev.virtualearth.net",key:"Ajp5EmHUiLfChanekLlwaiT8pCRVwAx9vIacAkCPdbt8dVcJ1qaOGvbbpMMCPbK9",mapStyle:Cesium.BingMapsStyle.AERIAL_WITH_LABELS});function setBingMapsAerialWithLabels(){}let particleSystem=scene.primitives.add(new Cesium.ParticleSystem({image:"https://cdn-icons-png.flaticon.com/512/589/589907.png",startColor:Cesium.Color.LIGHTSEAGREEN.withAlpha(.7),endColor:Cesium.Color.WHITE.withAlpha(0),startScale:santa2.startScale,endScale:santa2.endScale,minimumParticleLife:santa2.minimumParticleLife,maximumParticleLife:santa2.maximumParticleLife,minimumSpeed:santa2.minimumSpeed,maximumSpeed:santa2.maximumSpeed,imageSize:new Cesium.Cartesian2(santa2.particleSize,santa2.particleSize),emissionRate:viewModel.emissionRate,bursts:[new Cesium.ParticleBurst({time:5,minimum:10,maximum:100}),new Cesium.ParticleBurst({time:10,minimum:50,maximum:100}),new Cesium.ParticleBurst({time:15,minimum:200,maximum:300})],lifetime:16,emitter:new Cesium.CircleEmitter(2),emitterModelMatrix:computeEmitterModelMatrix(),updateCallback:applyGravity})),gravityScratch=new Cesium.Cartesian3;function applyGravity(e,t){var i=e.position;Cesium.Cartesian3.normalize(i,gravityScratch),Cesium.Cartesian3.multiplyByScalar(gravityScratch,santa2.gravity*t,gravityScratch),e.velocity=Cesium.Cartesian3.add(e.velocity,gravityScratch,e.velocity)}document.addEventListener("DOMContentLoaded",function(){setBingMapsAerialWithLabels()}),viewer.scene.skyBox=skyBox,Cesium.Ion.onError=handleCesiumIonError;